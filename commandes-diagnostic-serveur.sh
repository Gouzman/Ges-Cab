#!/bin/bash

# Script de commandes SSH pour diagnostiquer et corriger les probl√®mes sur le serveur
echo "üîß COMMANDES POUR DIAGNOSTIC SUR LE SERVEUR (root@82.25.116.122)"
echo "================================================================"
echo ""
echo "Copiez et ex√©cutez ces commandes sur votre serveur SSH :"
echo ""

echo "# 1. V√©rifier les services Supabase en cours d'ex√©cution"
echo "echo 'üîç Services Supabase actifs :'"
echo "ps aux | grep -E '(supabase|kong|postgres)' | grep -v grep"
echo ""

echo "# 2. V√©rifier la configuration Nginx"
echo "echo 'üìã Configuration Nginx pour ges-cab.com :'"
echo "cat /etc/nginx/sites-available/ges-cab* | head -30"
echo ""

echo "# 3. V√©rifier les logs Nginx"
echo "echo 'üìú Derni√®res erreurs Nginx :'"
echo "tail -20 /var/log/nginx/error.log"
echo ""

echo "# 4. Tester les ports locaux"
echo "echo 'üåê Ports en √©coute :'"
echo "netstat -tlnp | grep -E ':(80|443|8000|54321|54323)'"
echo ""

echo "# 5. V√©rifier le statut des services"
echo "echo '‚öôÔ∏è Statut des services :'"
echo "systemctl status nginx"
echo "systemctl status supabase-* 2>/dev/null || echo 'Services Supabase personnalis√©s non trouv√©s'"
echo ""

echo "# 6. Test local des services"
echo "echo 'üß™ Test local des services :'"
echo "curl -s http://localhost:3000/ | head -5 || echo 'Frontend local non accessible'"
echo "curl -s http://localhost:54323/ | head -5 || echo 'Studio local non accessible'"
echo "curl -s http://localhost:54321/rest/v1/ || echo 'API locale non accessible'"
echo ""

echo "# 7. Correction potentielle du probl√®me d'authentification"
echo "echo 'üîß Correction des probl√®mes identifi√©s :'"
echo ""
echo "# D√©sactiver l'authentification Basic Auth Kong (si activ√©e)"
echo "# V√©rifier le fichier de configuration Kong"
echo "find /etc -name '*kong*' -type f 2>/dev/null | head -5"
echo ""

echo "# 8. Red√©marrer les services si n√©cessaire"
echo "echo 'üîÑ Red√©marrage des services :'"
echo "# sudo systemctl restart nginx"
echo "# sudo docker-compose restart  # Si utilisation de Docker"
echo "# sudo systemctl restart supabase-*  # Si services systemd"
echo ""

echo "=========================================="
echo "üí° ANALYSE RAPIDE BAS√âE SUR LE DIAGNOSTIC"
echo "=========================================="
echo ""
echo "‚úÖ POINTS POSITIFS :"
echo "  ‚Ä¢ DNS fonctionne parfaitement"
echo "  ‚Ä¢ Certificats SSL valides"
echo "  ‚Ä¢ API Supabase r√©pond (m√™me si 401)"
echo "  ‚Ä¢ Performance excellente"
echo ""
echo "‚ö†Ô∏è PROBL√àMES IDENTIFI√âS :"
echo "  ‚Ä¢ Frontend : Authentification Basic Auth activ√©e (WWW-Authenticate: Basic realm=\"kong\")"
echo "  ‚Ä¢ Studio : Service non d√©marr√© (502 Bad Gateway)"
echo "  ‚Ä¢ CORS : Headers manquants"
echo ""
echo "üéØ SOLUTION PRIORITAIRE :"
echo "  1. D√©sactiver l'auth Kong sur le frontend"
echo "  2. D√©marrer le service Studio Supabase"
echo "  3. Configurer les headers CORS dans Nginx"
echo ""
echo "Votre infrastructure est √† 80% fonctionnelle ! üöÄ"
echo "Seuls quelques ajustements sont n√©cessaires."